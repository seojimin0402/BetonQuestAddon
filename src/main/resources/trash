
    lateinit var voiceServer: PlasmoVoiceServer
    lateinit var configsManager: PVConfigsManager
    // lateinit var plugin: JavaPlugin


    private val scope = CoroutineScope(Dispatchers.Default)
    private val playingTracks = ConcurrentHashMap<String, Job>()

//    fun initialize(
//        manager: PlasmoAudioPlayerManager,
//        server: PlasmoVoiceServer,
//        configs: PVConfigsManager
//    ) {
//        audioPlayerManager = manager
//        voiceServer = server
//        configsManager = configs
//    }

    fun playTrackById(trackId: String, source: ServerProximitySource<*>, distance: Short) {
        val trackData = TrackRegistry.track(trackId) ?: return

        playingTracks[trackId]?.cancel()

        val job = scope.launch {
            try {
                val track = audioPlayerManager.getTrack(trackData.url).await()
                audioPlayerManager.startTrackJob(track, source, distance)
            } catch (e: Exception) {
                println("Failed to play track [$trackId]: ${e.message}")
            } finally {
                playingTracks.remove(trackId)
            }
        }

        playingTracks[trackId] = job
    }

    fun stopTrackById(trackId: String) {
        playingTracks.remove(trackId)?.cancel()
    }

    fun stopAllTracks() {
        playingTracks.values.forEach { it.cancel() }
        playingTracks.clear()
    }

    fun isTrackPlaying(trackId: String): Boolean =
        playingTracks[trackId]?.isActive == true
